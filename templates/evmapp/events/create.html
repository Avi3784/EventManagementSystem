{% extends 'base.html' %}
{% load static %}

{% block title %}Create Event{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-0">Create New Event</h5>
                            <p class="text-sm mb-0">Enter the details for your new event</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3">
                    <form method="post" enctype="multipart/form-data" id="createEventForm">
                        {% csrf_token %}
                        
                        <!-- Event Basic Details -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group mb-3">
                                    <label for="name" class="form-control-label">Event Name *</label>
                                    <input class="form-control" type="text" id="name" name="name" required
                                           placeholder="Enter event name" value="{{ form.name.value|default:'' }}">
                                    {% if form.name.errors %}
                                    <div class="text-danger text-xs">{{ form.name.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="category" class="form-control-label">Category *</label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">Select category</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" {% if form.category.value == category.id %}selected{% endif %}>
                                            {{ category.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.category.errors %}
                                    <div class="text-danger text-xs">{{ form.category.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label for="description" class="form-control-label">Description *</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" required
                                              placeholder="Enter event description">{{ form.description.value|default:'' }}</textarea>
                                    {% if form.description.errors %}
                                    <div class="text-danger text-xs">{{ form.description.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Date, Time and Venue -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="date" class="form-control-label">Date *</label>
                                    <input class="form-control" type="date" id="date" name="date" required
                                           value="{{ form.date.value|date:'Y-m-d'|default:'' }}">
                                    {% if form.date.errors %}
                                    <div class="text-danger text-xs">{{ form.date.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="time" class="form-control-label">Time *</label>
                                    <input class="form-control" type="time" id="time" name="time" required
                                           value="{{ form.time.value|time:'H:i'|default:'' }}">
                                    {% if form.time.errors %}
                                    <div class="text-danger text-xs">{{ form.time.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="duration" class="form-control-label">Duration (hours)</label>
                                    <input class="form-control" type="number" id="duration" name="duration"
                                           placeholder="Enter duration in hours" value="{{ form.duration.value|default:'' }}" min="0" step="0.5">
                                    {% if form.duration.errors %}
                                    <div class="text-danger text-xs">{{ form.duration.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label for="venue" class="form-control-label">Venue *</label>
                                    <input class="form-control" type="text" id="venue" name="venue" required
                                           placeholder="Enter venue name/address" value="{{ form.venue.value|default:'' }}">
                                    {% if form.venue.errors %}
                                    <div class="text-danger text-xs">{{ form.venue.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Capacity and Pricing -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="capacity" class="form-control-label">Capacity *</label>
                                    <input class="form-control" type="number" id="capacity" name="capacity" required
                                           placeholder="Enter max capacity" value="{{ form.capacity.value|default:'' }}" min="1">
                                    {% if form.capacity.errors %}
                                    <div class="text-danger text-xs">{{ form.capacity.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="price" class="form-control-label">Price ($) *</label>
                                    <input class="form-control" type="number" id="price" name="price" required
                                           placeholder="Enter ticket price" value="{{ form.price.value|default:'' }}" min="0" step="0.01">
                                    {% if form.price.errors %}
                                    <div class="text-danger text-xs">{{ form.price.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="group_discount" class="form-control-label">Group Discount (%)</label>
                                    <input class="form-control" type="number" id="group_discount" name="group_discount"
                                           placeholder="Enter group discount" value="{{ form.group_discount.value|default:'' }}" min="0" max="100">
                                    {% if form.group_discount.errors %}
                                    <div class="text-danger text-xs">{{ form.group_discount.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Image Upload -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label for="image" class="form-control-label">Event Image</label>
                                    <input class="form-control" type="file" id="image" name="image" accept="image/*">
                                    {% if form.image.errors %}
                                    <div class="text-danger text-xs">{{ form.image.errors }}</div>
                                    {% endif %}
                                    <small class="text-muted">Recommended size: 1200x600 pixels. Max size: 5MB</small>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Settings -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured"
                                           {% if form.is_featured.value %}checked{% endif %}>
                                    <label class="form-check-label" for="is_featured">Feature this event</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="is_private" name="is_private"
                                           {% if form.is_private.value %}checked{% endif %}>
                                    <label class="form-check-label" for="is_private">Make this event private</label>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row mt-4">
                            <div class="col-12 text-end">
                                <a href="{% url 'event_list' %}" class="btn btn-outline-secondary me-2">Cancel</a>
                                <button type="submit" class="btn btn-primary">Create Event</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.getElementById('createEventForm');
    
    form.addEventListener('submit', function(event) {
        let isValid = true;
        
        // Required field validation
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });

        // Date validation
        const dateField = document.getElementById('date');
        const selectedDate = new Date(dateField.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
            isValid = false;
            dateField.classList.add('is-invalid');
            if (!dateField.nextElementSibling || !dateField.nextElementSibling.classList.contains('invalid-feedback')) {
                const feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                feedback.textContent = 'Event date cannot be in the past';
                dateField.parentNode.appendChild(feedback);
            }
        }

        // Price validation
        const priceField = document.getElementById('price');
        const price = parseFloat(priceField.value);
        if (price < 0) {
            isValid = false;
            priceField.classList.add('is-invalid');
        }

        // Capacity validation
        const capacityField = document.getElementById('capacity');
        const capacity = parseInt(capacityField.value);
        if (capacity < 1) {
            isValid = false;
            capacityField.classList.add('is-invalid');
        }

        if (!isValid) {
            event.preventDefault();
        }
    });

    // Image file validation
    const imageInput = document.getElementById('image');
    imageInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            // Check file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                event.target.value = '';
                return;
            }

            // Check file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload an image file (JPEG, PNG, or GIF)');
                event.target.value = '';
                return;
            }
        }
    });

    // Real-time price formatting
    const priceField = document.getElementById('price');
    priceField.addEventListener('input', function(e) {
        if (e.target.value !== '') {
            const price = parseFloat(e.target.value);
            if (!isNaN(price)) {
                e.target.value = price.toFixed(2);
            }
        }
    });
});
</script>
{% endblock %}